# Shared zuul config specific to the OpenStack Project
# Contains definitions of trusted jobs
# Overrides jobs from:
#    https://git.openstack.org/cgit/theopenlab/zuul-jobs
- job:
    name: base
    parent: null
    description: |
      The base job for OpenStack's installation of Zuul.

      All jobs ultimately inherit from this.  It runs a pre-playbook
      which copies all of the job's prepared git repos on to all of
      the nodes in the nodeset.  It runs a post-playbook which copies
      all of the files in the logs/ subdirectory of the executor
      work directory to the logserver.

      It also sets default timeout and nodeset values (which may be
      overidden).
    pre-run: playbooks/base/pre
    post-run:
      - playbooks/base/post-ssh
      - playbooks/base/post-logs
    roles:
      - zuul: theopenlab/zuul-jobs
      - zuul: theopenlab/openstack-zuul-jobs
    timeout: 1800
    nodeset:
      nodes:
        - name: ubuntu-xenial
          label: ubuntu-xenial

- job:
    name: base-minimal
    parent: null
    description: |
      A subset of what the 'base' job provides: the absolute minimum considered
      required to run for any one job.
      It doesn't set up cached git repositories, will not set up mirrors,
      doesn't validate the node and does not generate an ARA report.
      These tasks, if required, can be included by the dependant jobs
      themselves on a need basis.
    pre-run: playbooks/base-minimal/pre
    post-run:
      - playbooks/base-minimal/post-ssh
      - playbooks/base-minimal/post-logs
    roles:
      - zuul: theopenlab/zuul-jobs
    timeout: 1800
    nodeset:
      nodes:
        - name: ubuntu-xenial
          label: ubuntu-xenial

- job:
    name: base-test
    parent: null
    description: |
      A job to test changes to the base job without disturbing the
      main job in production.  Not for general use.
    pre-run: playbooks/base-test/pre
    post-run:
      - playbooks/base-test/post-ssh
      - playbooks/base-test/post-logs
    roles:
      - zuul: theopenlab/zuul-jobs
      - zuul: theopenlab/openstack-zuul-jobs
    timeout: 1800
    nodeset:
      nodes:
        - name: ubuntu-xenial
          label: ubuntu-xenial

- semaphore:
    name: wheel-mirror
    max: 1

- job:
    name: project-config-check-main-yaml
    pre-run: playbooks/check-main-yaml/pre
    run: playbooks/check-main-yaml/run
    post-run: playbooks/check-main-yaml/post
    allowed-projects:
      - theopenlab/project-config
    files:
      - zuul/main.yaml
      - gerrit/projects.yaml
